{"version":3,"file":"LeadsRequest.js","sourceRoot":"","sources":["../../../../src/integration/api/requests/LeadsRequest.ts"],"names":[],"mappings":"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","sourcesContent":["import { BaseRequests } from \"./BaseRequest\";\nimport { HeaderType } from \"../../assets/httpConstants\";\nimport { IHttpBuilder } from \"../../assets/interface/IHttpBuilder\";\n\nexport class LeadsRequests extends BaseRequests {\n  private table?: any;\n\n  private customerId?: any;\n\n  private leadsRepository: any;\n\n  private customerResponse?: any;\n\n  constructor(\n    protected props: IHttpBuilder,\n    shouldPrintRequest?: boolean,\n  ) {\n    super(shouldPrintRequest);\n    this.table = props.source.table;\n    this.customerId = props.source.customer.id;\n    this.leadsRepository = props.repositories.repository;\n    this.customerResponse = props.source.customer.response;\n  }\n\n  public async create(): Promise<any> {\n    const createPromises = this.table.hashes().map(async (row) => {\n      const buildRequest = this.buildCreateLead(row);\n      await this.printRequest(buildRequest);\n      return this.leadsRepository.create(buildRequest);\n    });\n    return this.execPromiseAll(createPromises);\n  }\n\n  public async findByIdentityDocument(props: {\n    documentType: string;\n    documentNumber: string;\n    amount?: number;\n    currency?: string;\n    status?: \"ACTIVE\";\n  }) {\n    const buildRequest = this.buildFindByIdentityDocument(props);\n    await this.printRequest(buildRequest);\n    return this.leadsRepository.findByIdentityDocument({\n      lead: buildRequest,\n      headerType: HeaderType.Employee,\n      isActive: props.status === \"ACTIVE\",\n    });\n  }\n\n  public async deleteAllLeads(): Promise<any> {\n    const deletePromises = this.table.hashes().map(async (row) => {\n      const buildRequest = this.buildDeleteAllLeads(row);\n      await this.printRequest(buildRequest);\n      return this.leadsRepository.deleteByIdentityDocument(buildRequest);\n    });\n\n    try {\n      return await this.execPromiseAll(deletePromises);\n    } catch (err) {\n      if (err.message !== \"Not found\") {\n        throw new Error(err);\n      }\n      return null;\n    }\n  }\n\n  public async find(leadId: string): Promise<any> {\n    return this.leadsRepository.find({\n      id: leadId,\n      customer: {\n        id: this.customerResponse.body.id,\n        identityDocument: {\n          type: this.customerResponse.body.identityDocument.type,\n          number: this.customerResponse.body.identityDocument.number,\n        },\n      },\n    });\n  }\n\n  public async createSale(leadId: string): Promise<any> {\n    const salePromises = this.table.hashes().map(async (row) => {\n      const buildRequest = this.buildSale(row, leadId);\n      await this.printRequest(buildRequest);\n      return this.leadsRepository.createSale(buildRequest);\n    });\n    return this.execPromiseAll(salePromises);\n  }\n\n  public async findLeadByStatus(status: string): Promise<any> {\n    const buildRequest = this.buildFindLeadByStatus();\n    await this.printRequest(buildRequest);\n    const request = await this.leadsRepository.findByCustomerId(\n      buildRequest,\n      status.includes(\"Active\"),\n    );\n    return request;\n  }\n\n  public async findExternalLead(props: {\n    documentType: string;\n    documentNumber: string;\n    email?: string;\n    mobile?: string;\n  }) {\n    const response = await this.leadsRepository.findExternalLead(props);\n    return response;\n  }\n\n  private buildFindLeadByStatus() {\n    return {\n      customer: {\n        id: this.customerResponse.body.id,\n        identityDocument: {\n          type: this.customerResponse.body.identityDocument.type,\n          number: this.customerResponse.body.identityDocument.number,\n        },\n      },\n    };\n  }\n\n  private buildSale(row: any, leadId: string) {\n    return {\n      id: leadId,\n      customer: { id: this.customerId },\n      term: parseInt(row.term, 10),\n      currency: row.currency,\n      amount: parseFloat(row.amount),\n      paymentDay: parseInt(row.paymentDay, 10),\n      metadata: {\n        \"external.id\": row.loanExternalId,\n        \"external.branch\": row.branch,\n        \"external.seller\": row.seller,\n      },\n    };\n  }\n\n  private buildDeleteAllLeads(row: any) {\n    return {\n      customer: {\n        identityDocument: {\n          type: row.documentType,\n          number: row.documentNumber,\n        },\n      },\n    };\n  }\n\n  private buildFindByIdentityDocument(props: any) {\n    return {\n      customer: {\n        identityDocument: {\n          type: props.documentType,\n          number: props.documentNumber,\n        },\n      },\n      amount: Number(props.amount),\n      currency: props.currency,\n      status: props.status,\n    };\n  }\n\n  private buildCreateLead(row: any) {\n    return {\n      campaignId: row.capaingnId,\n      annualNominalRate: row.annualNominalRate,\n      product: {\n        subType: row.subType,\n        type: row.type,\n      },\n      customer: {\n        identityDocument: {\n          type: row.documentType,\n          number: row.documentNumber,\n        },\n      },\n      amount: Number(row.amount),\n      interestRate: row.interestRate,\n      currency: row.currency,\n      expirationDate: Number(row.expirationDate) * 86400000 + Date.now(),\n      creationDate: Number(\n        row.creationDate.includes(\"today\") ? Date.now() : undefined,\n      ),\n      status: row.status,\n    };\n  }\n}\n"]}